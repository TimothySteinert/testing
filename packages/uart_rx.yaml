uart:
  id: uart_bus
  tx_pin: 22
  rx_pin: 21
  baud_rate: 9600
  debug:
    direction: RX
    dummy_receiver: true
    after:
      bytes: 16   # process full packet
    sequence:
      - lambda: |-
          if (bytes.size() != 16) return;

          uint8_t id_byte = bytes[0];
          uint8_t crc_calc = 0x00;
          for (int i = 0; i < 15; i++) {
            crc_calc ^= bytes[i];
          }
          uint8_t crc_recv = bytes[15];

          if (id_byte != 0xA0) {
            ESP_LOGW("uart_rx", "Ignored packet: wrong ID 0x%02X", id_byte);
            return;
          }

          if (crc_recv != crc_calc) {
            ESP_LOGW("uart_rx", "CRC mismatch: got 0x%02X expected 0x%02X", crc_recv, crc_calc);
            return;
          }

          // Extract prefix (bytes 1–3)
          std::string prefix;
          for (int i = 1; i <= 3; i++) {
            if (bytes[i] != 0x00) prefix.push_back((char)bytes[i]);
          }

          // Extract arm mode (byte 4)
          uint8_t arm_mode = bytes[4];

          // Extract PIN (bytes 5–14)
          std::string pin;
          for (int i = 5; i <= 14; i++) {
            if (bytes[i] != 0x00) pin.push_back((char)bytes[i]);
          }

          // Publish to sensors
          id(prefix_sensor).publish_state(prefix.c_str());
          id(pin_sensor).publish_state(pin.c_str());

          switch (arm_mode) {
            case 1: id(arm_mode_select).publish_state("Disarm"); break;
            case 2: id(arm_mode_select).publish_state("Away"); break;
            case 3: id(arm_mode_select).publish_state("Home"); break;
            case 4: id(arm_mode_select).publish_state("Night"); break;
            case 5: id(arm_mode_select).publish_state("Vacation"); break;
            case 6: id(arm_mode_select).publish_state("Bypass"); break;
            case 7: id(arm_mode_select).publish_state("Custom"); break;
            default: id(arm_mode_select).publish_state("None"); break;
          }

          ESP_LOGI("uart_rx", "Message parsed -> Prefix='%s', Arm Mode=%d, PIN='%s'",
            prefix.c_str(), arm_mode, pin.c_str());
