uart:
  id: uart_bus
  tx_pin: 22
  rx_pin: 21
  baud_rate: 9600
  debug:
    direction: RX
    dummy_receiver: true
    after:
      bytes: 16
    sequence:
      - lambda: |-
          if (bytes.size() != 16) return;

          uint8_t id_byte = bytes[0];
          uint8_t crc_calc = 0x00;
          for (int i = 0; i < 15; i++) crc_calc ^= bytes[i];
          uint8_t crc_recv = bytes[15];
          if (id_byte != 0xA0 || crc_recv != crc_calc) return;

          // Prefix
          std::string prefix;
          for (int i = 1; i <= 3; i++) {
            if (bytes[i] != 0x00) prefix.push_back((char)bytes[i]);
          }

          // Pin
          std::string pin;
          for (int i = 5; i <= 14; i++) {
            if (bytes[i] != 0x00) pin.push_back((char)bytes[i]);
          }

          // Arm mode dispatch
          switch (bytes[4]) {
            case 1:
              id(arm_handler).execute("Disarm", pin, prefix);
              break;
            case 2:
              id(arm_handler).execute("Away", pin, prefix);
              break;
            case 3:
              id(arm_handler).execute("Home", pin, prefix);
              break;
            case 4: {
              std::string mode = "${custom_mode}";
              if (mode == "Custom") {
                id(custom_handler).execute(pin, prefix);
              } else {
                id(arm_handler).execute(mode.c_str(), pin, prefix);
              }
              break;
            }
            default:
              // Invalid arm mode, ignore
              break;
          }
